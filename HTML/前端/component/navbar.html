<!-- 导航栏组件 -->
<nav class="navbar">
  <div class="nav-container">
    <a href="index.html" class="logo">
      <img src="../assets/img/logo.png" alt="驾云 Logo">
      驾云
    </a>
    <ul class="nav-links" id="navLinks">
      <!-- 动态加载菜单 -->
    </ul>
  </div>
</nav>

<style>
  /* 导航栏样式 */
  .navbar {
    position: fixed;
    top: 0;
    width: 100%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid #e2e8f0;
    z-index: 1000;
    transition: all 0.3s ease;
  }

  .nav-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .logo {
    display: flex;
    align-items: center;
    font-size: 2rem;
    font-weight: bold;
    color: #1e293b;
    text-decoration: none;
  }

  .logo img {
    height: 40px;
    margin-right: 0.5rem;
    filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.3));
  }

  .nav-links {
    display: flex;
    list-style: none;
    gap: 2rem;
    margin: 0;
    padding: 0;
  }

  .nav-links li {
    list-style: none;
  }

  .nav-links a {
    text-decoration: none;
    color: #64748b;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    position: relative;
    display: block;
  }

  .nav-links a::before {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, #3b82f6, #06b6d4);
    transform: translateX(-50%);
    transition: width 0.3s ease;
  }

  .nav-links a:hover::before {
    width: 80%;
  }

  .nav-links a:hover {
    color: #1e293b;
    transform: translateY(-2px);
  }

  .login-btn {
    background: linear-gradient(45deg, #3b82f6, #06b6d4) !important;
    color: white !important;
    padding: 0.75rem 1.5rem !important;
    border-radius: 25px;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    transition: all 0.3s ease;
  }

  .login-btn::before {
    display: none;
  }

  .login-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #1e293b !important;
    padding: 0.5rem 1rem !important;
    background: rgba(59, 130, 246, 0.1);
    border-radius: 20px;
    font-weight: 600;
  }

  .user-info::before {
    display: none;
  }

  .user-info:hover {
    background: rgba(59, 130, 246, 0.15);
    transform: none;
  }

  .logout-btn {
    background: linear-gradient(45deg, #ef4444, #dc2626) !important;
    color: white !important;
    padding: 0.75rem 1.5rem !important;
    border-radius: 25px;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    transition: all 0.3s ease;
    cursor: pointer;
    border: none;
    font-family: inherit;
    font-size: inherit;
    font-weight: 500;
  }

  .logout-btn::before {
    display: none;
  }

  .logout-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .nav-links {
      flex-direction: column;
      gap: 1rem;
    }

    .nav-container {
      flex-direction: column;
      gap: 1rem;
    }
  }
</style>

<script>
  // ============== 导航栏管理器 ==============
  const NavbarManager = {
    // 检查登录状态（基于token）
    checkLoginStatus() {
      // 检查 sessionStorage 中的 token
      const token = sessionStorage.getItem('token');
      return !!token;
    },

    // 获取用户信息
    getUserInfo() {
      const userInfo = sessionStorage.getItem('userInfo');
      return userInfo ? JSON.parse(userInfo) : null;
    },

    // 渲染未登录菜单
    renderGuestMenu() {
      const navLinks = document.getElementById('navLinks');
      if (!navLinks) return;

      navLinks.innerHTML = `
        <li><a href="index.html#home">首页</a></li>
        <li><a href="index.html#features">线上预约</a></li>
        <li><a href="index.html#coaches">教练团队</a></li>
        <li><a href="index.html#equipment">教学设备</a></li>
        <li><a href="login.html" class="login-btn">登录/注册</a></li>
      `;
    },

    // 渲染已登录菜单
    renderUserMenu() {
      const navLinks = document.getElementById('navLinks');
      if (!navLinks) return;

      const userInfo = this.getUserInfo();
      const userName = userInfo ? userInfo.name : '用户';

      navLinks.innerHTML = `
        <li><a href="index.html#home">首页</a></li>
        <li><a href="course.html">课程选择</a></li>
        <li><a href="coach.html">教练选择</a></li>
        <li><a href="reservation.html">车辆预约</a></li>
        <li><a href="profile.html" class="user-info">
          <i class="fa fa-user-circle"></i>
          ${userName}
        </a></li>
        <li><button class="logout-btn" id="logoutBtn">退出登录</button></li>
      `;

      // 绑定退出登录事件
      this.bindLogoutEvent();
    },

    // 绑定退出登录事件
    bindLogoutEvent() {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', this.handleLogout.bind(this));
      }
    },

    // 退出登录处理
    async handleLogout(event) {
      event.preventDefault();

      if (!confirm('确定要退出登录吗？')) {
        return;
      }

      try {
        // 如果有 ApiClient，调用退出登录API
        if (window.ApiClient) {
          await window.ApiClient.logout();
        } else {
          // 否则手动清除
          this.clearLoginData();
          window.location.href = 'index.html';
        }
      } catch (error) {
        console.error('退出登录失败:', error);
        // 即使API调用失败，也清除本地数据
        this.clearLoginData();
        window.location.href = 'login.html';
      }
    },

    // 清除登录数据
    clearLoginData() {
      sessionStorage.removeItem('token');
      sessionStorage.removeItem('refreshToken');
      sessionStorage.removeItem('userInfo');
      sessionStorage.removeItem('loginTime');
      console.log('登录数据已清除');
    },

    // 渲染导航菜单（主方法）
    renderNavMenu() {
      const isLoggedIn = this.checkLoginStatus();

      if (isLoggedIn) {
        this.renderUserMenu();
      } else {
        this.renderGuestMenu();
      }

      console.log('导航栏状态:', isLoggedIn ? '已登录' : '未登录');
    },

    // 监听登录状态变化
    watchLoginStatus() {
      let lastLoginStatus = this.checkLoginStatus();

      // 每500ms检查一次登录状态
      setInterval(() => {
        const currentLoginStatus = this.checkLoginStatus();

        // 状态发生变化时重新渲染
        if (currentLoginStatus !== lastLoginStatus) {
          console.log('登录状态变化:', currentLoginStatus ? '已登录' : '未登录');
          lastLoginStatus = currentLoginStatus;
          this.renderNavMenu();
        }
      }, 500);
    },

    // 初始化导航栏
    init() {
      this.renderNavMenu();
      this.watchLoginStatus();
    }
  };

  // ============== 全局暴露 ==============
  // 供外部调用更新导航栏
  window.updateNavbar = function () {
    NavbarManager.renderNavMenu();
  };

  // 供外部调用退出登录
  window.navbarLogout = function () {
    NavbarManager.handleLogout({ preventDefault: () => { } });
  };

  // ============== 初始化 ==============
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function () {
      NavbarManager.init();
    });
  } else {
    NavbarManager.init();
  }

  // 监听 storage 事件（跨标签页同步）
  window.addEventListener('storage', function (e) {
    if (e.key === 'token' || e.key === null) {
      NavbarManager.renderNavMenu();
    }
  });
</script>